<!DOCTYPE html>
<meta charset="utf-8">
<meta name="author" content="Atul Varma">
<title>Weekly Meeting Slideshow</title>
<!-- Date: 2010-09-26 -->
<link rel="stylesheet"
      href="http://labs.toolness.com/moz/slides-2/screen.css">
<style>
#templates, #response {
  display: none;
}

a {
  color: inherit;
}

a:hover {
  background: #f0f0f0;
}

.main {
  font-size: 18pt;
}

.main b {
  font-weight: normal;
  border-bottom: 1px dotted gray;
}

.main ul {
  list-style-type: none;
}

.main ul, .main li {
  padding-top: 0.25em;
  padding-bottom: 0.25em;
}
</style>
<script src="jquery.js"></script>
<script>
function parseWeeklyUpdate(doc) {
  $("img, video", doc).remove();

  var updates = $('<div class="updates"></div>');

  function doSection(heading) {
    var section = $('<div class="section"></div>');
    var lvl = parseInt(heading.nodeName.slice(1));
    var selArray = [];
    for (var i = 1; i <= lvl; i++)
      selArray.push('h' + i);
    var contents = $(heading).nextUntil(selArray.join(', '));
    var nextLvl = 'h' + (lvl + 1);
    var subsections = contents.filter(nextLvl);

    section.append($(heading).clone());
    if (subsections.length) {
      subsections.each(function() {
        section.append(doSection(this));
      });
    } else
      section.append(contents.clone());

    section.attr("id", "S_" + $(heading).find(".mw-headline").attr("id"));
    if (section.children().length > 1)
      return section;
    else
      return $();
  }

  doc.children("h1").each(function() {
    updates.append(doSection(this));
  });

  return updates;
}

const MONTHS = [
  'January', 'February', 'March', 'April', 'May', 'June',
  'July', 'August', 'September', 'October', 'November',
  'December'
];

// Taken from:
// http://stackoverflow.com/questions/1418050/string-strip-for-javascript
if(typeof(String.prototype.trim) === "undefined")
{
    String.prototype.trim = function() 
    {
        return String(this).replace(/^\s+|\s+$/g, '');
    };
}

function showUpdate(date) {
  var parts = date.match(/(\d+)-(\d+)-(\d+)/);
  var realDate = new Date(parts[1], parts[2], parts[3]);
  var title = "The Week of " +
              MONTHS[realDate.getMonth() - 1] + " " +
              realDate.getDate() + ", " + realDate.getFullYear();

  document.title = title;

  var url = 'http://localhost:8080/WeeklyUpdates/' + date;
  jQuery.get(url, function(html) {
    var updates = parseWeeklyUpdate($("#response").html(html));
    $("#response").remove();
    updates.find("#S_Speakers").remove();
    updates.find("#Video_for_today\\.27s_meeting").remove();

    var mainSection;
    var slides = [];
    
    updates.find(".section").each(function() {
      var header = $(this).find(":header:first");
      var subheader = header.text().trim();

      if ($(this).find(".section").length > 0) {
        mainSection = subheader;
      } else if (subheader.length > 0) {
        if (header.get(0).nodeName == "H2")
          subheader = mainSection + " - " + subheader;
        var slide = $("#templates div.slide.normal").clone();
        slide.find(".header").text(title);
        slide.find(".subheader").text(subheader);
        header.remove();
        slide.find(".main").append($(this).children());
        $(document.body).append(slide);
        slides.push(slide);
      }
    });

    var currSlide = 0;
    
    function nextSlide() {
      if (currSlide > 0) {
        slides[currSlide - 1].removeClass("selected");
      }
      slides[currSlide].addClass("selected");
      currSlide++;
      if (currSlide == slides.length)
        window.clearInterval(intervalID);
    }

    var intervalID = window.setInterval(nextSlide, 5000);
    
    nextSlide();
  });
}

$(window).ready(function() {
  var date = window.location.hash.slice(1);
  if (date.length == 0)
    date = '2006-03-27';
  showUpdate(date);
});
</script>
<div id="templates">
  <div class="normal slide"> 
    <div class="content"> 
      <div class="header"></div> 
      <div class="subheader"></div> 
      <div class="main"></div> 
    </div>
  </div>
</div>
<div id="response"></div>
